# TOML Sytax

## 基本概念与文件结构
TOML（Tom's Obvious, Minimal Language）是一种轻量级配置文件格式，旨在以简单、明确的方式表示键值对及其层级结构，易于人类阅读和机器解析。它直接映射为数据结构（如哈希表），避免歧义。


### 文件组成
- **键值对 (Key/Value Pair)**：基本单位，格式为 `key = value`，键和值之间用等号（`=`）分隔。
- **表 (Table)**：键值对的集合，用 `[table_name]`（标准表）或 `[[table_name]]`（数组表）定义。
- **注释 (Comment)**：以 `#` 开头，直到行尾，仅用于说明，不影响解析。
- **空白符与换行**：包括空格（` `）、制表符（`\t`）和换行符（LF 或 CRLF），仅用于格式化，无语义影响。

### 文件规则
- **编码**：必须使用 UTF-8，不支持其他编码（如 UTF-16）。
- **大小写敏感**：键名和特定值（如 `true`、`false`）区分大小写。
- **文件扩展名**：推荐 `.toml`，但语法不强制要求。
- **解析顺序**：从上到下顺序解析，后定义的同名键或表覆盖同一作用域内的前定义。
- **空白行**：允许任意数量，仅用于分隔，无语义。
- **非法字符**：键和值中不得包含未转义的控制字符（ASCII 0-31，除 `\t` 和 `\n` 外）。

**基础示例**：
```toml
key = "value"  # 键值对
# 这是一个注释

another_key = 42  # 空白行分隔
```

---

## 键 (Key)
键用于标识值，支持多种形式，分为裸键、引号键和点分键。

### 裸键 (Bare Key)
- **组成**：由字母（`A-Z`, `a-z`）、数字（`0-9`）、下划线（`_`）、连字符（`-`）组成。
- **限制**：
  - 不能以数字开头（如 `123key` 非法）。
  - 不能包含其他字符（如空格、`.`、`#` 等）。
  - 必须是非空的字符串。

**示例**：
```toml
key = "value"
my-key = 42
key_123 = true
```

### 引号键 (Quoted Key)
- **形式**：用单引号（`'`）或双引号（`"`）括起来。
- **功能**：支持任意 UTF-8 字符，包括空格、标点和特殊字符。
- **区别**：
  - **单引号**：字面键，不解析转义，原样输出。
  - **双引号**：支持转义字符（如 `\"`, `\n`, `\t`）。
- **转义规则**：与基本字符串一致（详见 3.1）。

**示例**：
```toml
"my key" = "value"
'key with spaces' = 123
"key\nwith\nescapes" = "test"
"key.with.dot" = 42
```

### 点分键 (Dotted Key)
- **形式**：用点号（`.`）分隔，表示嵌套层级，等价于嵌套表。
- **规则**：
  - 点号两侧必须是合法键（裸键或引号键）。
  - 不能以点号开头或结尾（如 `.key` 或 `key.` 非法）。
  - 不能连续使用点号（如 `key..sub` 非法）。
  - 隐式创建嵌套表。
- **用途**：简化嵌套表的定义。

**示例**：
```toml
server.port = 8080
"my.server"."db host" = "localhost"
```

**等价于**：
```toml
[server]
port = 8080

[my.server]
"db host" = "localhost"
```

### 键的合法性与作用域
- **唯一性**：同一作用域内（根表或同一表内），键名必须唯一，重复定义覆盖前值。
- **作用域**：
  - 未定义表的键值对属于根表（全局作用域）。
  - 定义表后，后续键值对属于该表，直到新表定义。
- **冲突**：
  - 点分键和显式表定义不能重叠。
  - 显式表定义会覆盖点分键的隐式结构。

**冲突示例**：
```toml
a.b = 1
[a]      # 定义 [a] 后
b = 2    # 覆盖 a.b = 1
```

**非法示例**：
```toml
123key = "value"    # 数字开头非法
key..sub = 42       # 连续点号非法
"a"."b".c = 1       # 引号键后接裸键非法
```

---

## 值 (Value)
TOML 支持 7 种数据类型，每种类型有明确的语法规则和限制。

### 字符串 (String)
- **基本字符串**：
  - 用双引号（`"`）括起来。
  - 支持转义字符：
    - `\b`（退格）、`\t`（制表符）、`\n`（换行）、`\f`（换页）、`\r`（回车）。
    - `\"`（引号）、`\\`（反斜杠）。
    - `\uXXXX`（4 位 Unicode，如 `\u00A9` 表示 ©）。
    - `\UXXXXXXXX`（8 位 Unicode，如 `\U0001F600` 表示 😊）。
  - 非法转义（如 `\z`）会导致解析错误。
- **字面字符串**：
  - 用单引号（`'`）括起来。
  - 不解析转义，原样输出。
- **多行基本字符串**：
  - 用三个双引号（`"""`）括起来。
  - 支持转义，首行后的换行符被忽略。
  - 行尾用 `\` 可忽略后续换行和前导空白（包括空格和 Tab）。
- **多行字面字符串**：
  - 用三个单引号（`'''`）括起来。
  - 不解析转义，首行后的换行符被忽略。
- **细节**：
  - 多行字符串中，缩进保留为内容的一部分。
  - 空字符串合法（如 `""` 或 `''`）。

**示例**：
```toml
basic = "Hello\nWorld"         # 带换行
literal = 'Hello\nWorld'       # \n 不转义
multi_basic = """
Line1
Line2"""                      # "Line1\nLine2"
multi_literal = '''Line1
Line2'''                       # "Line1\nLine2"
multi_cont = """Line1 \
Line2"""                       # "Line1 Line2"
unicode = "Copyright \u00A9"   # "Copyright ©"
empty = ""                     # 空字符串
```

### 整数 (Integer)
- **形式**：
  - **十进制**：如 `42` 或 `-17`。
  - **十六进制**：`0x` 前缀，允许 `0-9`, `a-f`, `A-F`。
  - **八进制**：`0o` 前缀，允许 `0-7`。
  - **二进制**：`0b` 前缀，允许 `0-1`。
- **下划线**：
  - 用于分隔数字，提高可读性。
  - 不能在开头、结尾、进制前缀后或连续使用（如 `_123`, `123_`, `0x_FF`, `1__2` 非法）。
- **范围**：`-2^63` 到 `2^63-1`（64 位有符号整数，即 -9,223,372,036,854,775,808 到 9,223,372,036,854,775,807）。
- **符号**：支持正号（`+`）和负号（`-`），正号可选。

**示例**：
```toml
dec = 42
neg = -17
big = 1_000_000
hex = 0xFF         # 255
oct = 0o755        # 493
bin = 0b1010       # 10
signed = +123
```

### 浮点数 (Float)
- **形式**：
  - **小数**：如 `3.14` 或 `-0.01`。
  - **指数**：如 `5e+22` 或 `1.23e-10`，必须包含指数部分（如 `1e` 非法）。
- **下划线**：
  - 可用于分隔数字。
  - 不能出现在小数点、指数符号（`e`/`E`）附近或连续使用（如 `1._23`, `1e_10`, `1__2` 非法）。
- **特殊值**：
  - `inf`（正无穷）、`-inf`（负无穷）、`nan`（非数字）。
  - 必须小写（如 `INF` 非法）。
- **范围**：符合 IEEE 754 64 位浮点数标准。
- **符号**：支持 `+` 和 `-`，正号可选。

**示例**：
```toml
dec = 3.14
neg = -0.01
exp = 5e+22
big = 1_000.5
inf = +inf
nan = nan
```

### 布尔值 (Boolean)
- **值**：仅 `true` 和 `false`。
- **限制**：
  - 必须小写（如 `True` 或 `FALSE` 非法）。
  - 无其他变体。

**示例**：
```toml
bool1 = true
bool2 = false
```

### 日期时间 (DateTime)
- **格式**：遵循 RFC 3339。
  - **偏移日期时间**：如 `1979-05-27T07:32:00Z`（UTC）或 `1979-05-27T07:32:00-08:00`（带时区偏移）。
  - **本地日期时间**：如 `1979-05-27T07:32:00`（无时区）。
  - **本地日期**：如 `1979-05-27`。
  - **本地时间**：如 `07:32:00`。
- **分隔符**：
  - 日期：`-`（如 `1979-05-27`）。
  - 时间：`:`（如 `07:32:00`）。
  - 日期与时间：`T` 或空格（如 `1979-05-27T07:32:00` 或 `1979-05-27 07:32:00`）。
- **精度**：支持毫秒（如 `.999`），更高精度（如 `.999999`）非法。
- **时区**：
  - `Z` 表示 UTC。
  - 偏移格式为 `±HH:MM`（如 `+08:00` 或 `-08:00`）。
- **范围**：理论上无限制，但受解析器实现约束。

**示例**：
```toml
offset_dt = 1979-05-27T07:32:00Z
local_dt = 1979-05-27 07:32:00
date = 1979-05-27
time = 07:32:00.999
offset = 2023-03-20T14:30:00+08:00
```

### 数组 (Array)
- **形式**：用方括号（`[ ]`）括起来，元素用逗号（`,`）分隔。
- **特性**：
  - 支持任意类型混合（包括嵌套数组）。
  - 可以单行或跨多行，末尾逗号可选。
  - 元素间可用空白符或换行分隔。
  - 空数组合法（如 `[]`）。
- **限制**：
  - 嵌套深度受解析器内存限制。
  - 不能包含未定义的值。

**示例**：
```toml
simple = [1, 2, 3]
mixed = ["red", 42, true]
nested = [[1, 2], [3, 4]]
multi = [
  1,
  "two",
  3.0,
]
empty = []
```

### 内联表 (Inline Table)
- **形式**：用大括号（`{ }`）括起来，键值对用逗号（`,`）分隔。
- **特性**：
  - 键可以是裸键或引号键。
  - 值可以是除内联表外的任意类型。
  - 键值对顺序无语义影响。
  - 空内联表合法（如 `{}`）。
- **限制**：
  - 不能嵌套内联表（如 `{ a = { b = 1 } }` 非法）。
  - 不能跨行。
  - 等号两侧可有空白符。

**示例**：
```toml
point = { x = 1, y = 2 }
mixed = { key = "value", num = 42, flag = true }
empty = {}
```

---

## 表 (Table)
表是键值对的集合，用于组织数据，支持嵌套和数组形式。

### 标准表 (Standard Table)
- **定义**：用单方括号（`[table_name]`），表名可以是裸键、引号键或点分键。
- **特性**：
  - 定义后，后续键值对属于该表，直到新表定义。
  - 同一表可分段定义，后续键值对追加到该表。
  - 表名区分大小写。
- **限制**：
  - 不能与点分键定义的表冲突。
  - 空表合法（仅定义 `[table_name]` 而不赋值）。

**示例**：
```toml
[table1]
key1 = "value1"
key2 = 42

[table1]  # 追加
key3 = "value3"

[table2.subtable]
key4 = "value4"
```

#### 4.2 数组表 (Array of Tables)
- **定义**：用双重方括号（`[[table_name]]`），表示表的数组。
- **特性**：
  - 每个 `[[table_name]]` 是一个独立对象，追加到数组。
  - 支持嵌套子表（用 `[table_name.subtable]` 或 `[[table_name.subtable]]`）。
  - 空数组表合法（仅定义 `[[table_name]]`）。
- **限制**：
  - 所有 `[[table_name]]` 必须连续定义，中途插入其他表非法。
  - 数组表不能与标准表同名。

**示例**：
```toml
[[products]]
name = "Hammer"
sku = 738594937

[[products]]
name = "Nail"
sku = 284758393
```

**非法示例**：
```toml
[[items]]
key = 1
[other]       # 中途插入其他表
key = 2
[[items]]     # 非法，items 必须连续
key = 3
```

#### 4.3 表与点分键的交互
- **隐式定义**：点分键自动创建嵌套表。
- **覆盖规则**：
  - 显式表定义覆盖点分键的隐式结构。
  - 同一表内，后定义的键值对覆盖前值。

**示例**：
```toml
a.b.c = 1
[a.b]  # 覆盖 a.b.c
d = 2
```

**解析结果**：
- `a.b`：`{ d = 2 }`

---

### 5. 语法规则与约束
#### 5.1 键值对格式
- **分隔符**：键和值之间必须用单个 `=`，两侧可有任意空白符。
- **单行限制**：每行只能定义一个键值对（多行值除外）。
- **值缺失**：如 `key =` 非法。

#### 5.2 键的唯一性
- **规则**：同一作用域内（根表或同一表），键名必须唯一，重复定义覆盖前值。
- **冲突**：点分键和显式表定义不能重叠。

#### 5.3 空白与换行
- **空白符**：空格（` `）和制表符（`\t`）用于分隔，无语义。
- **换行符**：LF（`\n`）或 CRLF（`\r\n`）结束行，多行值（如数组、字符串）对换行敏感。
- **多行值格式**：首行后的换行符通常被忽略（字符串除外）。

#### 5.4 注释
- **形式**：`#` 开头，直到行尾。
- **限制**：
  - 不支持块注释。
  - 不能出现在多行值内部（如数组或多行字符串中）。
- **位置**：可出现在行首或行尾。

**示例**：
```toml
# 行首注释
key = "value"  # 行尾注释
```

**非法示例**：
```toml
array = [
  1,
  # 注释  # 多行值内非法
  2
]
```

#### 5.5 文件编码与字符
- **编码**：必须 UTF-8。
- **非法字符**：未转义的控制字符（ASCII 0-31，除 `\t` 和 `\n` 外）非法。

---

### 6. 复杂结构与形象化表示
以下是复杂结构的详细示例及其可视化。

#### 6.1 嵌套表与点分键
```toml
[server]
port = 8080
[server.database]
host = "localhost"
port = 5432
```

**形象化表示**：
```
server (表)
├── port: 8080
└── database (表)
    ├── host: "localhost"
    └── port: 5432
```

#### 6.2 数组表与嵌套子表
```toml
[[users]]
name = "Alice"
[[users.groups]]
id = 1
role = "admin"

[[users]]
name = "Bob"
[[users.groups]]
id = 2
role = "user"
```

**形象化表示**：
```
users (数组)
├── [0] (表)
│   ├── name: "Alice"
│   └── groups (数组)
│       └── [0] (表)
│           ├── id: 1
│           └── role: "admin"
└── [1] (表)
    ├── name: "Bob"
    └── groups (数组)
        └── [0] (表)
            ├── id: 2
            └── role: "user"
```

#### 6.3 数组与内联表混合
```toml
[data]
points = [
  { x = 1, y = 2 },
  { x = 3, y = 4 }
]
mixed = [
  42,
  "string",
  { key = "value" }
]
```

**形象化表示**：
```
data (表)
├── points (数组)
│   ├── [0] (内联表)
│   │   ├── x: 1
│   │   └── y: 2
│   └── [1] (内联表)
│       ├── x: 3
│       └── y: 4
└── mixed (数组)
    ├── [0]: 42
    ├── [1]: "string"
    └── [2] (内联表)
        └── key: "value"
```

#### 6.4 多级嵌套与数组表
```toml
[[teams]]
name = "Team A"
[[teams.members]]
id = 1
role = "Leader"
[[teams.members]]
id = 2
role = "Member"

[[teams]]
name = "Team B"
[[teams.members]]
id = 3
role = "Leader"
```

**形象化表示**：
```
teams (数组)
├── [0] (表)
│   ├── name: "Team A"
│   └── members (数组)
│       ├── [0] (表)
│       │   ├── id: 1
│       │   └── role: "Leader"
│       └── [1] (表)
│           ├── id: 2
│           └── role: "Member"
└── [1] (表)
    ├── name: "Team B"
    └── members (数组)
        └── [0] (表)
            ├── id: 3
            └── role: "Leader"
```

---

### 7. 边缘情况与错误示例
#### 7.1 非法语法
```toml
key =              # 缺少值
"a"."b" = 1        # 点分键中连续引号键非法
[[table]]          # 数组表缺少内容
key = true         # 重复定义冲突
key = false
array = [
  1,
  # 注释         # 多行值内注释非法
  2
]
True = 1           # 布尔值大小写非法
1e = 1             # 指数缺少部分非法
```

#### 7.2 合法但复杂的情况
```toml
[a.b.c]
d = 1
[a.b]  # 覆盖 a.b.c
e = 2
```

**解析结果**：
- `a.b`：`{ e = 2 }`

#### 7.3 空结构的合法性
```toml
empty_array = []
empty_table = {}
[empty_standard_table]
[[empty_array_table]]
```

---

### 8. 完整综合示例
以下是包含所有语法元素的完整 TOML 文件：

```toml
# 根键值对
title = "Complete TOML Example"
version = 1_0_0
active = true
pi = 3.14159
infinity = +inf
timestamp = 2023-03-20T14:30:00.999Z

# 字符串类型
basic_str = "Hello\nWorld"
literal_str = 'Hello\nWorld'
multi_str = """
Line1
Line2"""
multi_literal = '''Line1
Line2'''
multi_cont = """Line1 \
Line2"""
unicode = "Smile \U0001F600"

# 嵌套表
[server]
host = "localhost"
port = 8080
[server.auth]
method = "token"
key = "abc123"

# 数组表
[[users]]
id = 1
name = "Alice"
[[users.groups]]
role = "admin"
perms = ["read", "write"]

[[users]]
id = 2
name = "Bob"
[[users.groups]]
role = "user"
perms = ["read"]

# 内联表与混合数组
[settings]
config = { enabled = true, timeout = 30 }
data = [
  1,
  "two",
  { x = 3, y = 4 }
]
```

**形象化表示**：
```
root (表)
├── title: "Complete TOML Example"
├── version: 100
├── active: true
├── pi: 3.14159
├── infinity: +inf
├── timestamp: 2023-03-20T14:30:00.999Z
├── basic_str: "Hello\nWorld"
├── literal_str: "Hello\\nWorld"
├── multi_str: "Line1\nLine2"
├── multi_literal: "Line1\nLine2"
├── multi_cont: "Line1 Line2"
├── unicode: "Smile 😊"
├── server (表)
│   ├── host: "localhost"
│   ├── port: 8080
│   └── auth (表)
│       ├── method: "token"
│       └── key: "abc123"
├── users (数组)
│   ├── [0] (表)
│   │   ├── id: 1
│   │   ├── name: "Alice"
│   │   └── groups (数组)
│   │       └── [0] (表)
│   │           ├── role: "admin"
│   │           └── perms: ["read", "write"]
│   └── [1] (表)
│       ├── id: 2
│       ├── name: "Bob"
│       └── groups (数组)
│           └── [0] (表)
│               ├── role: "user"
│               └── perms: ["read"]
└── settings (表)
    ├── config (内联表)
    │   ├── enabled: true
    │   └── timeout: 30
    └── data (数组)
        ├── [0]: 1
        ├── [1]: "two"
        └── [2] (内联表)
            ├── x: 3
            └── y: 4
```

---

### 9. 总结
TOML 语法包括：
- **键**：裸键（字母、数字、`-`、`_`）、引号键（单引号或双引号）、点分键（嵌套）。
- **值**：字符串（基本、字面、多行）、整数（十进制、十六进制等）、浮点数（小数、指数、特殊值）、布尔值（`true`/`false`）、日期时间（RFC 3339）、数组（混合类型）、内联表（紧凑键值对）。
- **表**：标准表（`[ ]`）、数组表（`[[ ]]`），支持嵌套。
- **规则**：键唯一性、UTF-8 编码、大小写敏感、注释（`#`）、空白格式化。
