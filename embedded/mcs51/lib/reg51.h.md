---


`source code`

> ---`start`
```
/*--------------------------------------------------------------------------
REG51.H

Header file for generic 80C51 and 80C31 microcontroller.
Copyright (c) 1988-2002 Keil Elektronik GmbH and Keil Software, Inc.
All rights reserved.
--------------------------------------------------------------------------*/

#ifndef __REG51_H__
#define __REG51_H__

/*  BYTE Register  */
sfr P0   = 0x80;
sfr P1   = 0x90;
sfr P2   = 0xA0;
sfr P3   = 0xB0;
sfr PSW  = 0xD0;
sfr ACC  = 0xE0;
sfr B    = 0xF0;
sfr SP   = 0x81;
sfr DPL  = 0x82;
sfr DPH  = 0x83;
sfr PCON = 0x87;
sfr TCON = 0x88;
sfr TMOD = 0x89;
sfr TL0  = 0x8A;
sfr TL1  = 0x8B;
sfr TH0  = 0x8C;
sfr TH1  = 0x8D;
sfr IE   = 0xA8;
sfr IP   = 0xB8;
sfr SCON = 0x98;
sfr SBUF = 0x99;


/*  BIT Register  */
/*  PSW   */
sbit CY   = 0xD7;
sbit AC   = 0xD6;
sbit F0   = 0xD5;
sbit RS1  = 0xD4;
sbit RS0  = 0xD3;
sbit OV   = 0xD2;
sbit P    = 0xD0;

/*  TCON  */
sbit TF1  = 0x8F;
sbit TR1  = 0x8E;
sbit TF0  = 0x8D;
sbit TR0  = 0x8C;
sbit IE1  = 0x8B;
sbit IT1  = 0x8A;
sbit IE0  = 0x89;
sbit IT0  = 0x88;

/*  IE   */
sbit EA   = 0xAF;
sbit ES   = 0xAC;
sbit ET1  = 0xAB;
sbit EX1  = 0xAA;
sbit ET0  = 0xA9;
sbit EX0  = 0xA8;

/*  IP   */
sbit PS   = 0xBC;
sbit PT1  = 0xBB;
sbit PX1  = 0xBA;
sbit PT0  = 0xB9;
sbit PX0  = 0xB8;

/*  P3  */
sbit RD   = 0xB7;
sbit WR   = 0xB6;
sbit T1   = 0xB5;
sbit T0   = 0xB4;
sbit INT1 = 0xB3;
sbit INT0 = 0xB2;
sbit TXD  = 0xB1;
sbit RXD  = 0xB0;

/*  SCON  */
sbit SM0  = 0x9F;
sbit SM1  = 0x9E;
sbit SM2  = 0x9D;
sbit REN  = 0x9C;
sbit TB8  = 0x9B;
sbit RB8  = 0x9A;
sbit TI   = 0x99;
sbit RI   = 0x98;

#endif
```


> ---`end`

---


## **reg51.h 库详解**

`reg51.h` 是为 MCS-51 系列单片机（如 AT89C51）设计的头文件，主要用于 Keil C51 编译器。它通过 `sfr` 和 `sbit` 关键字定义了8051单片机的特殊功能寄存器（SFR），允许开发者直接操作硬件。本节将分三部分介绍：字节寄存器、位寄存器和完整代码示例。

---

### **1. 字节寄存器（sfr）**
特殊功能寄存器（SFR）是8051单片机内部的硬件寄存器，位于内存地址 0x80 到 0xFF。每个寄存器占用 1 字节（8 位），通过 `sfr` 关键字映射到固定地址。以下是 `reg51.h` 中定义的所有字节寄存器，按地址顺序排列。

| **寄存器名** | **地址** | **功能描述**                                                                                   | **默认值** | **备注**                              |
|--------------|----------|-----------------------------------------------------------------------------------------------|------------|---------------------------------------|
| `P0`         | 0x80     | 端口 0，8 位双向 I/O 口，可复用为外部存储器的低 8 位地址/数据总线（AD0-AD7）。                  | 0xFF       | 上电后为输入状态，需配置为输出使用。   |
| `SP`         | 0x81     | 堆栈指针，指向内部 RAM 中的堆栈位置，用于函数调用和中断。                                       | 0x07       | 默认指向 RAM 地址 0x07。              |
| `DPL`        | 0x82     | 数据指针低字节，与 `DPH` 组成 16 位数据指针（DPTR），用于外部存储器寻址。                      | 0x00       |                                       |
| `DPH`        | 0x83     | 数据指针高字节，与 `DPL` 配合使用。                                                            | 0x00       |                                       |
| `PCON`       | 0x87     | 电源控制寄存器，控制功耗模式和串口波特率倍增。                                                 | 0x00       | 部分位功能因型号而异。                |
| `TCON`       | 0x88     | 定时器控制寄存器，控制定时器 0/1 的运行及外部中断触发。                                        | 0x00       | 位可寻址，详见下文。                  |
| `TMOD`       | 0x89     | 定时器模式寄存器，设置定时器 0/1 的工作模式。                                                  | 0x00       | 非位可寻址。                          |
| `TL0`        | 0x8A     | 定时器 0 低字节，与 `TH0` 组成 16 位计数值。                                                   | 0x00       | 非位可寻址。                          |
| `TL1`        | 0x8B     | 定时器 1 低字节，与 `TH1` 组成 16 位计数值。                                                   | 0x00       | 非位可寻址。                          |
| `TH0`        | 0x8C     | 定时器 0 高字节，与 `TL0` 组成 16 位计数值。                                                   | 0x00       | 非位可寻址。                          |
| `TH1`        | 0x8D     | 定时器 1 高字节，与 `TL1` 组成 16 位计数值。                                                   | 0x00       | 非位可寻址。                          |
| `P1`         | 0x90     | 端口 1，8 位双向 I/O 口，通用输入输出端口。                                                    | 0xFF       | 上电后为输入状态。                    |
| `SCON`       | 0x98     | 串口控制寄存器，设置串口工作模式、使能接收等。                                                 | 0x00       | 位可寻址，详见下文。                  |
| `SBUF`       | 0x99     | 串口数据缓冲器，用于发送和接收数据的存储。                                                     | 未定义     | 读写分离（读接收，写发送）。          |
| `P2`         | 0xA0     | 端口 2，8 位双向 I/O 口，可复用为外部存储器的高 8 位地址总线（A8-A15）。                       | 0xFF       | 上电后为输入状态。                    |
| `IE`         | 0xA8     | 中断使能寄存器，控制各种中断的使能状态。                                                       | 0x00       | 位可寻址，详见下文。                  |
| `P3`         | 0xB0     | 端口 3，8 位双向 I/O 口，每位有复用功能（如串口、中断、定时器输入等）。                         | 0xFF       | 位可寻址，详见下文。                  |
| `IP`         | 0xB8     | 中断优先级寄存器，设置各个中断的优先级。                                                       | 0x00       | 位可寻址，详见下文。                  |
| `PSW`        | 0xD0     | 程序状态字，包含 CPU 状态标志（如进位、溢出等）。                                              | 0x00       | 位可寻址，详见下文。                  |
| `ACC`        | 0xE0     | 累加器，8 位寄存器，用于算术和逻辑运算的主要操作数。                                           | 0x00       | 可位寻址，但 `reg51.h` 未定义其位。   |
| `B`          | 0xF0     | B 寄存器，用于乘法和除法运算的辅助寄存器。                                                     | 0x00       | 可位寻址，但 `reg51.h` 未定义其位。   |

---

### **2. 位寄存器（sbit）**
部分 SFR 是位可寻址的，即其 8 个位可以单独访问。这些寄存器的地址是 8 的倍数（如 0x88、0x90 等），每个位通过 `sbit` 定义为独立变量。位地址是硬件层面的编号（范围 0x00-0x7F），由字节地址和位偏移计算得出：
- **位地址计算**：`(字节地址 - 0x80) / 8 * 8 + 位偏移`。
- 在 C 中，`sbit` 使用 `寄存器^位偏移` 语法，编译器自动映射到位地址。

以下是 `reg51.h` 中定义的所有位寄存器，按所属 SFR 分组。

#### **PSW（程序状态字，字节地址 0xD0）**
- **位地址范围**：0x50 - 0x57

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `P`      | 0          | 0x50       | 奇偶校验标志，`ACC` 中 1 的个数为奇数时置 1，否则为 0。                      |
| `-`      | 1          | 0x51       | 未使用，保留位。                                                            |
| `OV`     | 2          | 0x52       | 溢出标志，有符号数运算溢出时置 1。                                          |
| `RS0`    | 3          | 0x53       | 寄存器组选择位 0，与 `RS1` 组合选择工作寄存器组（00=组0，11=组3）。         |
| `RS1`    | 4          | 0x54       | 寄存器组选择位 1。                                                          |
| `F0`     | 5          | 0x55       | 用户标志 0，可由程序员自由使用。                                            |
| `AC`     | 6          | 0x56       | 辅助进位标志，BCD 运算中低 4 位向高 4 位进位时置 1。                        |
| `CY`     | 7          | 0x57       | 进位标志，算术运算产生进位或借位时置 1。                                    |

#### **TCON（定时器控制寄存器，字节地址 0x88）**
- **位地址范围**：0x08 - 0x0F

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `IT0`    | 0          | 0x08       | 外部中断 0 触发方式，0=低电平触发，1=下降沿触发。                           |
| `IE0`    | 1          | 0x09       | 外部中断 0 标志，触发时置 1，需软件清零。                                    |
| `IT1`    | 2          | 0x0A       | 外部中断 1 触发方式，0=低电平触发，1=下降沿触发。                           |
| `IE1`    | 3          | 0x0B       | 外部中断 1 标志，触发时置 1，需软件清零。                                    |
| `TR0`    | 4          | 0x0C       | 定时器 0 运行控制，1=启动，0=停止。                                         |
| `TF0`    | 5          | 0x0D       | 定时器 0 溢出标志，计数溢出时置 1，需软件清零。                              |
| `TR1`    | 6          | 0x0E       | 定时器 1 运行控制，1=启动，0=停止。                                         |
| `TF1`    | 7          | 0x0F       | 定时器 1 溢出标志，计数溢出时置 1，需软件清零。                              |

#### **IE（中断使能寄存器，字节地址 0xA8）**
- **位地址范围**：0x28 - 0x2F

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `EX0`    | 0          | 0x28       | 外部中断 0 使能，1=允许，0=禁止。                                           |
| `ET0`    | 1          | 0x29       | 定时器 0 中断使能，1=允许，0=禁止。                                         |
| `EX1`    | 2          | 0x2A       | 外部中断 1 使能，1=允许，0=禁止。                                           |
| `ET1`    | 3          | 0x2B       | 定时器 1 中断使能，1=允许，0=禁止。                                         |
| `ES`     | 4          | 0x2C       | 串口中断使能，1=允许，0=禁止。                                              |
| `-`      | 5          | 0x2D       | 未使用，保留位。                                                            |
| `-`      | 6          | 0x2E       | 未使用，保留位。                                                            |
| `EA`     | 7          | 0x2F       | 全局中断使能，1=允许所有使能的中断，0=禁用所有中断。                         |

#### **IP（中断优先级寄存器，字节地址 0xB8）**
- **位地址范围**：0x38 - 0x3F

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `PX0`    | 0          | 0x38       | 外部中断 0 优先级，1=高优先级，0=低优先级。                                 |
| `PT0`    | 1          | 0x39       | 定时器 0 中断优先级，1=高优先级，0=低优先级。                               |
| `PX1`    | 2          | 0x3A       | 外部中断 1 优先级，1=高优先级，0=低优先级。                                 |
| `PT1`    | 3          | 0x3B       | 定时器 1 中断优先级，1=高优先级，0=低优先级。                               |
| `PS`     | 4          | 0x3C       | 串口中断优先级，1=高优先级，0=低优先级。                                    |
| `-`      | 5          | 0x3D       | 未使用，保留位。                                                            |
| `-`      | 6          | 0x3E       | 未使用，保留位。                                                            |
| `-`      | 7          | 0x3F       | 未使用，保留位。                                                            |

#### **P3（端口 3，字节地址 0xB0）**
- **位地址范围**：0x30 - 0x37

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `RXD`    | 0          | 0x30       | 串口接收引脚（复用功能）。                                                  |
| `TXD`    | 1          | 0x31       | 串口发送引脚（复用功能）。                                                  |
| `INT0`   | 2          | 0x32       | 外部中断 0 输入引脚（复用功能）。                                           |
| `INT1`   | 3          | 0x33       | 外部中断 1 输入引脚（复用功能）。                                           |
| `T0`     | 4          | 0x34       | 定时器 0 外部输入，用于计数器模式（复用功能）。                              |
| `T1`     | 5          | 0x35       | 定时器 1 外部输入，用于计数器模式或波特率发生器（复用功能）。                |
| `WR`     | 6          | 0x36       | 写信号，外部存储器写操作时输出低电平（复用功能）。                           |
| `RD`     | 7          | 0x37       | 读信号，外部存储器读操作时输出低电平（复用功能）。                           |

#### **SCON（串口控制寄存器，字节地址 0x98）**
- **位地址范围**：0x18 - 0x1F

| **位名** | **位偏移** | **位地址** | **功能描述**                                                                 |
|----------|------------|------------|-----------------------------------------------------------------------------|
| `RI`     | 0          | 0x18       | 接收中断标志，接收完成时置 1，需软件清零。                                   |
| `TI`     | 1          | 0x19       | 发送中断标志，发送完成时置 1，需软件清零。                                   |
| `RB8`    | 2          | 0x1A       | 接收数据第 8 位，模式 2/3 中接收的第 9 位数据。                              |
| `TB8`    | 3          | 0x1B       | 发送数据第 8 位，模式 2/3 中发送的第 9 位数据。                              |
| `REN`    | 4          | 0x1C       | 串口接收使能，1=允许接收，0=禁止接收。                                      |
| `SM2`    | 5          | 0x1D       | 多机通信控制位，1=启用多机通信模式（检查第 9 位），0=禁用。                  |
| `SM1`    | 6          | 0x1E       | 串口模式选择位 1，与 `SM0` 组合定义模式。                                   |
| `SM0`    | 7          | 0x1F       | 串口模式选择位 0，与 `SM1` 组合定义模式。                                   |

**串口模式表（SM0 和 SM1）**：
| SM0 | SM1 | 模式 | 描述                  | 波特率来源         |
|-----|-----|------|-----------------------|--------------------|
| 0   | 0   | 0    | 8 位移位寄存器        | 固定（fosc/12）    |
| 0   | 1   | 1    | 8 位 UART，可变波特率 | 定时器 1           |
| 1   | 0   | 2    | 9 位 UART，固定波特率 | fosc/32 或 fosc/64|
| 1   | 1   | 3    | 9 位 UART，可变波特率 | 定时器 1           |

---

### **3. 非位可寻址寄存器的位定义**
以下寄存器不是位可寻址的，但其各位有特定功能，只能通过字节操作访问。

#### **TMOD（定时器模式寄存器，地址 0x89）**
| **位** | **7** | **6** | **5** | **4** | **3** | **2** | **1** | **0** |
|--------|-------|-------|-------|-------|-------|-------|-------|-------|
| **名** | GATE  | C/T   | M1    | M0    | GATE  | C/T   | M1    | M0    |
| **定时器** | T1    | T1    | T1    | T1    | T0    | T0    | T0    | T0    |

- **GATE**：门控位，1=外部引脚（INT0/INT1）控制定时器，0=TRx 控制。
- **C/T**：计数/定时选择，1=计数器模式（外部脉冲），0=定时器模式（内部时钟）。
- **M1, M0**：工作模式：
  - 00：模式 0，13 位定时器/计数器。
  - 01：模式 1，16 位定时器/计数器。
  - 10：模式 2，8 位自动重载。
  - 11：模式 3，T0 分拆为两个 8 位定时器，T1 停止。

#### **PCON（电源控制寄存器，地址 0x87）**
| **位** | **7** | **6** | **5** | **4** | **3** | **2** | **1** | **0** |
|--------|-------|-------|-------|-------|-------|-------|-------|-------|
| **名** | SMOD  | -     | -     | -     | GF1   | GF0   | PD    | IDL   |

- **SMOD**：串口波特率倍增，1=波特率加倍，0=正常。
- **GF1, GF0**：通用标志位，用户自定义。
- **PD**：掉电模式，1=进入掉电模式。
- **IDL**：空闲模式，1=进入空闲模式。
- **-**：未使用位，部分型号可能有扩展功能。

---

### **4. 完整代码（reg51.h）**
以下是 `reg51.h` 的完整定义，符合 Keil C51 标准：

```c
#ifndef __REG51_H__
#define __REG51_H__

/* 字节寄存器（sfr） */
sfr P0    = 0x80;  // 端口 0
sfr SP    = 0x81;  // 堆栈指针
sfr DPL   = 0x82;  // 数据指针低字节
sfr DPH   = 0x83;  // 数据指针高字节
sfr PCON  = 0x87;  // 电源控制
sfr TCON  = 0x88;  // 定时器控制
sfr TMOD  = 0x89;  // 定时器模式
sfr TL0   = 0x8A;  // 定时器 0 低字节
sfr TL1   = 0x8B;  // 定时器 1 低字节
sfr TH0   = 0x8C;  // 定时器 0 高字节
sfr TH1   = 0x8D;  // 定时器 1 高字节
sfr P1    = 0x90;  // 端口 1
sfr SCON  = 0x98;  // 串口控制
sfr SBUF  = 0x99;  // 串口缓冲器
sfr P2    = 0xA0;  // 端口 2
sfr IE    = 0xA8;  // 中断使能
sfr P3    = 0xB0;  // 端口 3
sfr IP    = 0xB8;  // 中断优先级
sfr PSW   = 0xD0;  // 程序状态字
sfr ACC   = 0xE0;  // 累加器
sfr B     = 0xF0;  // B 寄存器

/* 位寄存器（sbit） */
sbit CY   = PSW^7;   // 进位标志，位地址 0x57
sbit AC   = PSW^6;   // 辅助进位标志，位地址 0x56
sbit F0   = PSW^5;   // 用户标志 0，位地址 0x55
sbit RS1  = PSW^4;   // 寄存器组选择 1，位地址 0x54
sbit RS0  = PSW^3;   // 寄存器组选择 0，位地址 0x53
sbit OV   = PSW^2;   // 溢出标志，位地址 0x52
sbit P    = PSW^0;   // 奇偶校验标志，位地址 0x50

sbit TF1  = TCON^7;  // 定时器 1 溢出标志，位地址 0x0F
sbit TR1  = TCON^6;  // 定时器 1 运行控制，位地址 0x0E
sbit TF0  = TCON^5;  // 定时器 0 溢出标志，位地址 0x0D
sbit TR0  = TCON^4;  // 定时器 0 运行控制，位地址 0x0C
sbit IE1  = TCON^3;  // 外部中断 1 标志，位地址 0x0B
sbit IT1  = TCON^2;  // 外部中断 1 触发方式，位地址 0x0A
sbit IE0  = TCON^1;  // 外部中断 0 标志，位地址 0x09
sbit IT0  = TCON^0;  // 外部中断 0 触发方式，位地址 0x08

sbit EA   = IE^7;    // 全局中断使能，位地址 0x2F
sbit ES   = IE^4;    // 串口中断使能，位地址 0x2C
sbit ET1  = IE^3;    // 定时器 1 中断使能，位地址 0x2B
sbit EX1  = IE^2;    // 外部中断 1 使能，位地址 0x2A
sbit ET0  = IE^1;    // 定时器 0 中断使能，位地址 0x29
sbit EX0  = IE^0;    // 外部中断 0 使能，位地址 0x28

sbit PS   = IP^4;    // 串口中断优先级，位地址 0x3C
sbit PT1  = IP^3;    // 定时器 1 中断优先级，位地址 0x3B
sbit PX1  = IP^2;    // 外部中断 1 优先级，位地址 0x3A
sbit PT0  = IP^1;    // 定时器 0 中断优先级，位地址 0x39
sbit PX0  = IP^0;    // 外部中断 0 优先级，位地址 0x38

sbit RD   = P3^7;    // 读信号，位地址 0x37
sbit WR   = P3^6;    // 写信号，位地址 0x36
sbit T1   = P3^5;    // 定时器 1 外部输入，位地址 0x35
sbit T0   = P3^4;    // 定时器 0 外部输入，位地址 0x34
sbit INT1 = P3^3;    // 外部中断 1，位地址 0x33
sbit INT0 = P3^2;    // 外部中断 0，位地址 0x32
sbit TXD  = P3^1;    // 串口发送，位地址 0x31
sbit RXD  = P3^0;    // 串口接收，位地址 0x30

sbit SM0  = SCON^7;  // 串口模式 0，位地址 0x1F
sbit SM1  = SCON^6;  // 串口模式 1，位地址 0x1E
sbit SM2  = SCON^5;  // 多机通信控制，位地址 0x1D
sbit REN  = SCON^4;  // 接收使能，位地址 0x1C
sbit TB8  = SCON^3;  // 发送第 8 位，位地址 0x1B
sbit RB8  = SCON^2;  // 接收第 8 位，位地址 0x1A
sbit TI   = SCON^1;  // 发送中断标志，位地址 0x19
sbit RI   = SCON^0;  // 接收中断标志，位地址 0x18

#endif
```

---

### **5. 补充说明**
1. **位地址与字节地址的区别**：
   - 字节地址（如 0xD0）是 SFR 的内存地址，占用 1 字节。
   - 位地址（如 0x57）是硬件层面的位编号，用于汇编指令（如 `SETB 0x57`）。在 C 中，`sbit` 通过 `寄存器^位偏移` 映射到位地址。

2. **使用方法**：
   - 包含头文件后，直接操作变量：
     - 字节操作：`P0 = 0xFF;`（设置整个端口）。
     - 位操作：`TI = 1;`（置位发送中断标志）。

3. **适用范围**：
   - `reg51.h` 适用于标准 8051 单片机（如 AT89C51）。增强型型号（如 AT89C52）需使用 `reg52.h`，增加定时器 2 等支持。

4. **硬件依赖性**：
   - SFR 的行为受硬件控制。例如，`TF0` 由定时器溢出置 1，软件只能清零。

---

### **6. 示例验证**
以下是一个简单的测试代码，验证部分寄存器功能：

```c
#include <reg51.h>

void main() {
    P0 = 0x00;    // 初始化 P0
    TMOD = 0x01;  // 定时器 0，模式 1
    TH0 = 0xFC;   // 50ms 初值（12MHz 晶振）
    TL0 = 0x66;
    TR0 = 1;      // 启动定时器

    while (1) {
        if (TF0 == 1) {
            TF0 = 0;  // 清除溢出标志
            P0 = ~P0; // 反转 P0 状态
            TH0 = 0xFC;
            TL0 = 0x66;
        }
    }
}
```
